# GameNative Modifications
# Last Updated: 2026-02-11
# Purpose: Add community components/drivers repository, fix library art/navigation, and add UI/UX improvements

================================================================================
## SUMMARY OF CHANGES
================================================================================

Major improvements and new features:
1. Integrated 'maxjivi05/Components' GitHub repository for online component and driver downloads.
2. Contents Manager now pulls directly from the MTR repo (GN toggle removed for clarity).
3. Driver Manager now includes a GN/MTR toggle to switch between official and community drivers.
4. Implemented version-aware sorting for the MTR driver list, ensuring the newest versions (e.g., 1.8.5) appear at the top.
5. Fixed app refreshing and resetting to the library screen when returning from the background.
6. Implemented robust automatic icon extraction for custom games, supporting both PNG and BMP sources.
7. Fixed library grid art issues by using valid 'file://' URIs with 'lastModified' timestamping for cache-busting.
8. Set the default toggle for "Ask for a tip on startup" to OFF.
9. Added a "Stretch To Fullscreen" button to the in-game navigation menu (back button popup).
10. Implemented a Computer Monitor icon for the "Stretch To Fullscreen" feature and stretching logic to fit the video to every corner of the screen.

================================================================================
## FILE: app/src/main/java/app/gamenative/PrefManager.kt
================================================================================

### Change 1: Set default 'tipped' state to true
- Changed default value of `TIPPED` preference from `false` to `true` to disable the startup tip message by default.

================================================================================
## FILE: app/src/main/res/values/strings.xml
================================================================================

### Change 1: Added stretch_to_fullscreen string
- Added `<string name="stretch_to_fullscreen">Stretch To Fullscreen</string>` for the new menu item.

================================================================================
## FILE: app/src/main/res/drawable/icon_monitor.xml (NEW FILE)
================================================================================

### Change 1: Created Monitor Icon
- Added a vector drawable representing a computer monitor to be used in the navigation menu.

================================================================================
## FILE: app/src/main/java/com/winlator/contentdialog/NavigationDialog.java
================================================================================

### Change 1: Added Stretch To Fullscreen Action and Menu Item
- Added `ACTION_STRETCH_TO_FULLSCREEN` constant.
- Added `addMenuItem` call for the "Stretch To Fullscreen" option using `icon_monitor` and `stretch_to_fullscreen` string.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/xserver/XServerScreen.kt
================================================================================

### Change 1: Handled ACTION_STRETCH_TO_FULLSCREEN
- Added a listener case for `ACTION_STRETCH_TO_FULLSCREEN` which calls `xServerView?.renderer?.toggleFullscreen()`.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/settings/ContentsManagerDialog.kt
================================================================================

### Change 1: MTR Integration and UI Simplification
- Defaulted to 'ContentSource.MTR' and removed the source toggle buttons.
- Implemented dynamic fetching of 'contents.json' from maxjivi05 GitHub repo.
- Added dropdowns for component categories (DXVK, VKD3D, Box64, WOWBox64, FEXCore) and their versions.
- Unified the view to show both online repository downloads and local .wcp imports.

================================================================================
## FILE: app/src/main/java/app/gamenative/utils/SaveManager.kt (NEW FILE)
================================================================================

### Change 1: Created SaveManager
- Implemented logic to identifying game save folders within the container.
- Added `exportSave` function to zip save directories matching the game name.
- Added `importSave` function to unzip save files and remap `steamuser` paths to `xuser` for GameHub compatibility.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/enums/AppOptionMenuType.kt
================================================================================

### Change 1: Added Import/Export Save options
- Added `ImportSave` and `ExportSave` enum values.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/library/appscreen/BaseAppScreen.kt
================================================================================

### Change 1: Implemented Import/Export Save UI
- Added `exportSaveLauncher` and `importSaveLauncher` using `rememberLauncherForActivityResult`.
- Added "Import Save" and "Export Save" menu items to the game options menu.
- Placed "Import Save" and "Export Save" immediately after "Edit Container" for better accessibility.
- Wired menu items to trigger the respective launchers and call `SaveManager`.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/component/picker/DownloadFolderPicker.kt (NEW FILE)
================================================================================

### Change 1: Created DownloadFolderPicker
- Implemented a reusable Composable for selecting download folders.
- Uses `ActivityResultContracts.OpenDocumentTree` to allow users to pick any folder.
- Persists URI permissions to ensure access to the selected folder.

================================================================================
## FILE: app/src/main/java/app/gamenative/service/SteamService.kt
================================================================================

### Change 1: Added Custom Install Path Support
- Updated `downloadApp` to accept an optional `customInstallPath`.
- Modified `downloadApp` to update the `SteamApp` database entry with the selected `installDir` if a custom path is provided.
- Updated `getAppDirPath` to check `SteamApp.installDir` first, ensuring games installed in custom locations are correctly located.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/library/appscreen/SteamAppScreen.kt
================================================================================

### Change 1: Integrated Download Picker
- Added `rememberDownloadFolderPicker` to `AdditionalDialogs`.
- Updated `GameManagerDialog`'s `onInstall` handler to trigger the folder picker instead of starting the download immediately.
- Passed the selected path to `SteamService.downloadApp`.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/library/appscreen/EpicAppScreen.kt
================================================================================

### Change 1: Integrated Download Picker
- Added `rememberDownloadFolderPicker` to `AdditionalDialogs`.
- Updated `EpicGameManagerDialog`'s `onInstall` and install confirmation dialog to trigger the folder picker.
- Updated `performDownload` to accept a `customInstallPath` and use it if provided.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/library/appscreen/GOGAppScreen.kt
================================================================================

### Change 1: Integrated Download Picker
- Added `rememberDownloadFolderPicker` to `AdditionalDialogs`.
- Updated install confirmation dialog to trigger the folder picker.
- Updated `performDownload` to accept a `customInstallPath` and use it if provided.

================================================================================
## FILE: app/src/main/java/app/gamenative/service/SteamService.kt
================================================================================

### Change 2: Subfolder Creation for Custom Downloads
- Modified `downloadApp` to automatically append the game's folder name to the selected custom install path.
- This ensures games are installed in their own subdirectories (e.g., `.../Games/MyGame`) instead of mixing files in the root of the selected folder, preventing accidental deletion of other games.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/library/appscreen/EpicAppScreen.kt
================================================================================

### Change 2: Subfolder Creation for Custom Downloads
- Updated `performDownload` to append the game's `appName` or sanitized title to the custom install path.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/library/appscreen/GOGAppScreen.kt
================================================================================

### Change 2: Subfolder Creation for Custom Downloads
- Updated `performDownload` to append the sanitized game name to the custom install path.

### Change 3: Fixed Library Installation Status
- Updated `SteamService.getAppDirPath` to unconditionally return the custom `installDir` from the database if present, removing the potentially failing `Files.exists` check. This ensures `isAppInstalled` (which relies on marker files in the directory) checks the correct custom location.

### Change 4: Enhanced Safety for Subfolder Creation
- Added fallback logic in `EpicAppScreen` and `GOGAppScreen` to use the sanitized App ID as the subfolder name if the game title sanitization results in an empty string. This prevents games from being installed directly into the root of the selected folder (e.g., if the game name is only special characters), safeguarding against accidental deletion of the entire parent directory during uninstall.

### Change 5: Fixed Library Sorting for Custom Installs
- Updated `LibraryViewModel` to use `AppInfoDao` for determining installed games instead of checking default directories via `DownloadService`. This ensures games installed to custom paths are correctly recognized as installed, fixing filtering and ensuring they appear at the top of the sorted list.

### Change 1: MTR Integration and UI Simplification
- Defaulted to 'ContentSource.MTR' and removed the source toggle buttons.
- Implemented dynamic fetching of 'contents.json' from maxjivi05 GitHub repo.
- Added dropdowns for component categories (DXVK, VKD3D, Box64, WOWBox64, FEXCore) and their versions.
- Unified the view to show both online repository downloads and local .wcp imports.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/settings/DriverManagerDialog.kt
================================================================================

### Change 1: Added Source Toggle and MTR Integration
- Added DriverSource enum (GN, MTR).
- Implemented dynamic listing of driver ZIP files from 'maxjivi05/Components/Drivers' via GitHub API.
- Unified download and installation logic to handle both GameNative official drivers and MTR community drivers.

### Change 2: Implemented Version-Aware Sorting for MTR Drivers
- Added a custom comparator to the MTR driver dropdown.
- Extracts version strings (e.g., "v1.8.5") and compares them numerically in descending order.
- Ensures the latest releases are always prioritized at the top of the list.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/PluviaMain.kt
================================================================================

### Change 1: Added isInitialLaunch guard to navigation in OnLogonEnded
- Added 'isInitialLaunch' check to prevent navigation resets when resuming the app.

================================================================================
## FILE: app/src/main/java/app/gamenative/utils/ExeIconExtractor.kt
================================================================================

### Change 1: Added tryExtractMainIconAsPng with robust BMP reconstruction
- New function to extract the largest icon from an EXE and save it as a PNG with proper headers.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/library/appscreen/CustomGameAppScreen.kt
================================================================================

### Change 1: Updated onAfterFetchImages to use centralized cache and force update
- Switched to internal cache storage and implemented 'force update' for custom game icons.

================================================================================
## FILE: app/src/main/java/app/gamenative/utils/CustomGameScanner.kt
================================================================================

### Change 1: Implemented Centralized Icon Cache
- All custom game icons are now stored in a centralized, always-writable internal location.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/screen/library/components/LibraryAppItem.kt
================================================================================

### Change 1: Implemented Cache Bypassing via Timestamping
- Added '?t=[lastModified]' to local icon URIs to ensure immediate UI updates.

================================================================================
## FILE: app/src/main/java/app/gamenative/service/SteamService.kt
================================================================================

### Change 6: Improved Custom Path Logic
- Updated `downloadApp` to detect if the user selected the game folder itself (by matching folder name). If matched, it uses the selected folder directly instead of creating a nested subfolder. This fixes issues with "Locating" existing games.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/component/dialog/GameManagerDialog.kt
================================================================================

### Change 1: Added Locate Button
- Added a "Locate / Custom Install" button (folder icon) to the dialog to explicitly allow users to select an install location.

================================================================================
## FILE: app/src/main/java/app/gamenative/ui/component/dialog/EpicGameManagerDialog.kt
================================================================================

### Change 1: Added Locate Button
- Added a "Locate / Custom Install" button (folder icon) to the dialog.

================================================================================
## BUILD OUTPUT
================================================================================

Debug APK location: /home/max/Build/GameNative/app/build/outputs/apk/debug/app-debug.apk

================================================================================
## BEHAVIOR CHANGES
================================================================================

BEFORE:
- Managers only supported local file imports or a fixed set of official drivers.
- Community drivers were sorted alphabetically, often burying new versions at the bottom.
- Navigation reset to Home when resuming from background.
- Custom game icons were often missing or failed to update.
- Installing an existing game to a custom path often created nested folders (e.g. `Game/Game`), failing to detect files.
- No explicit "Locate Game" option in Steam/Epic install dialogs.

AFTER:
- Contents Manager directly provides access to the latest DXVK, VKD3D, and Box64 versions from the MTR repository.
- Driver Manager allows toggling between "GN" (Official) and "MTR" community drivers.
- MTR drivers are intelligently sorted by version, placing the newest releases (like v1.8.5) at the top.
- Seamless "one-tap" download and installation for all community components.
- App state and scroll position are preserved when switching tasks.
- Custom game art is robustly extracted and displays instantly in the library grid.
- "Install" dialogs for Steam and Epic now include a "Locate" folder button.
- Selecting an existing game folder correctly uses that folder without creating duplicates, instantly detecting installed files.
